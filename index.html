<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Hitler Pass and Play Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        // --- Firebase Setup (Mandatory, even if not directly storing game state) ---
        // This boilerplate is required for the environment. Future updates can use this
        // to enable real-time multiplayer functionality via Firestore.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Define global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let currentUserId = 'initializing';
        
        const initFirebase = async () => {
            if (firebaseConfig) {
                try {
                    setLogLevel('Debug');
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                    currentUserId = auth.currentUser?.uid || crypto.randomUUID();
                    console.log("Firebase initialized. User ID:", currentUserId);
                } catch (error) {
                    console.error("Firebase initialization failed:", error);
                    currentUserId = crypto.randomUUID(); // Fallback ID
                }
            } else {
                console.warn("Firebase config not available. Running without persistence.");
                currentUserId = crypto.randomUUID(); // Fallback ID
            }
        };

        initFirebase();
        // ---------------------------------------------------------------------

        // --- Game Persistence (Local Storage) ---
        const SAVE_KEY = 'secretHitlerGameState';
        
        const saveGameState = () => {
            try {
                const serializedState = JSON.stringify(gameState);
                localStorage.setItem(SAVE_KEY, serializedState);
            } catch (error) {
                console.error("Could not save state to localStorage:", error);
            }
        };

        const loadGameState = () => {
            try {
                const serializedState = localStorage.getItem(SAVE_KEY);
                if (serializedState === null) return undefined;
                return JSON.parse(serializedState);
            } catch (error) {
                console.error("Could not load or parse state from localStorage:", error);
                return undefined;
            }
        };

        const clearSavedGameState = () => {
             try {
                localStorage.removeItem(SAVE_KEY);
            } catch (error) {
                console.error("Could not clear state from localStorage:", error);
            }
        };
        
        // --- Default Game State Definition ---
        const DEFAULT_GAME_STATE = {
            view: 'setup',
            playerCount: 5,
            players: [], // Player objects use ID (1, 2, 3...)
            revealIndex: 0,
            policies: {
                liberal: 0,
                fascist: 0 
            },
            failedElections: 0,
            policyPeekAvailable: false, 
            peekedPolicies: [], 
            deck: [],
            discard: [],
            currentPolicies: [],
            sessionPhase: null, 
            nextPhaseData: null, 
            isWakeLockActive: false, // Tracks user's preference for screen wake lock
        };

        // --- Game State Initialization (Load from storage or use default) ---
        const loadedState = loadGameState();
        // Use Object.assign to merge the loaded state over the default, providing resilience
        const gameState = Object.assign({}, DEFAULT_GAME_STATE, loadedState);

        // --- Wake Lock Management ---
        let wakeLockSentinel = null;

        const requestWakeLock = async () => {
            if (!('wakeLock' in navigator)) {
                console.warn("Wake Lock API not supported.");
                gameState.isWakeLockActive = false; // Disable if not supported
                render();
                return;
            }
            if (wakeLockSentinel) return; // Already active

            try {
                wakeLockSentinel = await navigator.wakeLock.request('screen');
                wakeLockSentinel.addEventListener('release', () => {
                    console.log('Wake Lock released by system or manually.');
                    wakeLockSentinel = null;
                    gameState.isWakeLockActive = false;
                    render(); 
                });
                console.log('Wake Lock successfully requested.');
                gameState.isWakeLockActive = true;
            } catch (err) {
                console.error('Failed to acquire Wake Lock (User permission denied or system policy):', err);
                gameState.isWakeLockActive = false;
                wakeLockSentinel = null;
            }
            render(); 
        };

        const releaseWakeLock = () => {
            if (wakeLockSentinel) {
                wakeLockSentinel.release();
                wakeLockSentinel = null;
                gameState.isWakeLockActive = false;
                console.log('Wake Lock manually released.');
            }
            render(); 
        };
        
        // Handle visibility changes (re-request if the lock was active but dropped when the tab went invisible)
        document.addEventListener('visibilitychange', () => {
            if (gameState.isWakeLockActive && document.visibilityState === 'visible' && !wakeLockSentinel) {
                // If the user preferred the lock, and the tab becomes visible, re-request it.
                requestWakeLock();
            } 
        });
        
        // --- Game Logic continues ---

        // --- CORRECTED ROLE AND BOARD DISTRIBUTION (Using user's provided power positions) ---
        // Powers array indices 0-5 correspond to F1-F6 policy slots.
        // F6 is always Fascist Win (no power)
        const ROLE_DISTRIBUTION = {
            // 5-6 Players: blank - blank - investigate - kill - kill
            5: { L: 3, F: 1, H: 1, 
                // F1, F2, F3 (Investigate), F4 (Execution), F5 (Execution), F6 (Win)
                powers: ['-', '-', 'Peak next policies', 'Execution', 'Execution', '-'],
                knowledge: "Fascist and Hitler know each other."
            },
            6: { L: 4, F: 1, H: 1, 
                // F1, F2, F3 (Investigate), F4 (Execution), F5 (Execution), F6 (Win)
                powers: ['-', '-', 'Investigate Loyalty', 'Execution', 'Execution', '-'],
                knowledge: "Fascist and Hitler know each other."
            },
            // 7-8 Players: blank - investigate - special election - kill - kill
            7: { L: 4, F: 2, H: 1, 
                // F1, F2 (Investigate), F3 (Special), F4 (Execution), F5 (Execution), F6 (Win)
                powers: ['-', 'Investigate Loyalty', 'Special Election', 'Execution', 'Execution', '-'],
                knowledge: "Fascists know each other and <strong>know who Hitler is</strong>, but <strong>Hitler does NOT know the Fascists</strong>."
            },
            8: { L: 5, F: 2, H: 1, 
                // F1, F2 (Investigate), F3 (Special), F4 (Execution), F5 (Execution), F6 (Win)
                powers: ['-', 'Investigate Loyalty', 'Special Election', 'Execution', 'Execution', '-'],
                knowledge: "Fascists know each other and <strong>know who Hitler is</strong>, but <strong>Hitler does NOT know the Fascists</strong>."
            },
            // 9-10 Players: investigate - investigate - special election - kill - kill
            9: { L: 5, F: 3, H: 1, 
                // F1 (Investigate), F2 (Investigate), F3 (Special), F4 (Execution), F5 (Execution), F6 (Win)
                powers: ['Investigate Loyalty', 'Investigate Loyalty', 'Special Election', 'Execution', 'Execution', '-'],
                knowledge: "Fascists know each other and <strong>know who Hitler is</strong>, but <strong>Hitler does NOT know the Fascists</strong>."
            },
            10: { L: 6, F: 3, H: 1, 
                // F1 (Investigate), F2 (Investigate), F3 (Special), F4 (Execution), F5 (Execution), F6 (Win)
                powers: ['Investigate Loyalty', 'Investigate Loyalty', 'Special Election', 'Execution', 'Execution', '-'],
                knowledge: "Fascists know each other and <strong>know who Hitler is</strong>, but <strong>Hitler does NOT know the Fascists</strong>."
            },
        };

        const render = () => {
            const container = document.getElementById('app-container');
            container.innerHTML = '';
            
            switch (gameState.view) {
                case 'setup':
                    container.appendChild(renderSetup());
                    break;
                case 'role_reveal':
                    container.appendChild(renderRoleReveal());
                    break;
                case 'game_board':
                    container.appendChild(renderGameBoard());
                    break;
                case 'legislation_session':
                    container.appendChild(renderLegislationSession());
                    break;
                case 'policy_peek_display':
                    container.appendChild(renderPolicyPeekDisplay());
                    break;
                case 'privacy_screen': 
                    container.appendChild(renderPrivacyScreen());
                    break;
            }
            // Ensure policy track updates, especially when returning from a session
            updatePolicyTrack();
            // --- SAVE GAME STATE AFTER EVERY RENDER ---
            saveGameState();
        };

        // --- Utility Functions ---

        /** Shuffles an array in place (Fisher-Yates) */
        const shuffle = (array) => {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                // CORRECTED: Standard array destructuring swap
                [array[i], array[j]] = [array[j], array[i]];
            }
        };
        
        // --- Deck Management Functions ---
        const initDeck = () => {
            const newDeck = [];
            // 6 Liberal Policies
            for (let i = 0; i < 6; i++) {
                newDeck.push('Liberal');
            }
            // 11 Fascist Policies
            for (let i = 0; i < 11; i++) {
                newDeck.push('Fascist');
            }
            shuffle(newDeck);
            gameState.deck = newDeck;
            gameState.discard = [];
            console.log(`Deck initialized: ${gameState.deck.length} cards.`);
        };
        
        const drawPolicy = () => {
            if (gameState.deck.length === 0) {
                if (gameState.discard.length > 0) {
                    gameState.deck = gameState.discard;
                    gameState.discard = [];
                    shuffle(gameState.deck);
                } else {
                    console.error("No more cards left to draw in the deck or discard pile.");
                    return undefined;
                }
            }
            return gameState.deck.pop();
        };

        const drawThreePolicies = () => {
            const drawn = [];
            for (let i = 0; i < 3; i++) {
                const policy = drawPolicy();
                if (policy) {
                    drawn.push(policy);
                }
            }
            gameState.currentPolicies = drawn;
        };


        const assignRoles = (playerCount) => {
            const dist = ROLE_DISTRIBUTION[playerCount];
            if (!dist) return;

            const roles = [];
            for (let i = 0; i < dist.L; i++) roles.push('Liberal');
            for (let i = 0; i < dist.F; i++) roles.push('Fascist');
            roles.push('Hitler');

            shuffle(roles);

            // Store player roles using simple numerical ID
            gameState.players = roles.map((role, index) => ({
                id: index + 1, // Player ID (1, 2, 3...)
                role: role,
                party: role === 'Liberal' ? 'Liberal' : 'Fascist',
            }));
            
            // --- Corrected Teammate Knowledge Logic ---
            const hitlerId = gameState.players.find(p => p.role === 'Hitler')?.id;
            const otherFascistIds = gameState.players.filter(p => p.role === 'Fascist').map(p => p.id);
            // All Fascist party members (Fascists + Hitler)
            const allFascistPartyMembers = otherFascistIds.concat(hitlerId).filter(id => id !== null);

            gameState.players.forEach(p => {
                // Default: Known teammates list uses IDs (1, 2, 3...)
                p.knownTeammates = []; 

                // 5-6 Players: Fascists and Hitler know all Fascist Party members.
                if (playerCount <= 6 && p.party === 'Fascist') {
                    // Fascist and Hitler know all other members of the Fascist party
                    p.knownTeammates = allFascistPartyMembers.filter(id => id !== p.id);
                } 
                // 7+ Players: Fascists know all Fascist Party members (including Hitler). Hitler knows NO ONE.
                else if (playerCount >= 7) {
                    if (p.role === 'Fascist') {
                        // Fascists know all other members of the Fascist party (including Hitler)
                        p.knownTeammates = allFascistPartyMembers.filter(id => id !== p.id);
                    }
                    // If p.role === 'Hitler', p.knownTeammates remains [] (Hitler knows no one).
                    // If p.role === 'Liberal', p.knownTeammates remains [] (Liberal knows no one).
                }
            });
        };

        /** Returns the Presidential power granted by the enacted Fascist policy number (1-6). */
        const getPowerDescription = (policiesPassed) => {
            const count = gameState.playerCount;
            const powers = ROLE_DISTRIBUTION[count]?.powers;
            
            // policiesPassed is 1 (F1) through 6 (F6)
            
            if (!powers) return '-';
            // The powers array is 0-indexed and corresponds to F1-F6
            if (policiesPassed >= 1 && policiesPassed <= 6) { 
                // Index lookup: F1 (1) is index 0. F6 (6) is index 5.
                return powers[policiesPassed - 1]; 
            }
            return '-'; 
        };
        
        // --- Legislation Logic ---
        
        const startLegislation = () => {
            if (gameState.policies.liberal >= 5 || gameState.policies.fascist >= 6) {
                console.error("The game has already ended! Start a new game.");
                return;
            }

            drawThreePolicies();
            if (gameState.currentPolicies.length < 3) {
                 console.error("Could not draw 3 policies. Check the deck count or if the game has ended.");
                 return;
            }
            
            // Transition to privacy screen for the President
            gameState.nextPhaseData = { type: 'legislation', role: 'President' };
            gameState.sessionPhase = 'PRESIDENT_DISCARD';
            gameState.view = 'privacy_screen';
            render();
        };

        const handleDiscard = (discardIndex) => {
            const policies = gameState.currentPolicies;
            const discardedPolicy = policies.splice(discardIndex, 1)[0];
            gameState.discard.push(discardedPolicy);

            if (gameState.sessionPhase === 'PRESIDENT_DISCARD') {
                // Go to privacy screen for the Chancellor
                gameState.sessionPhase = 'CHANCELLOR_DISCARD';
                gameState.nextPhaseData = { type: 'legislation', role: 'Chancellor' };
                gameState.view = 'privacy_screen';
            } else if (gameState.sessionPhase === 'CHANCELLOR_DISCARD') {
                const enactedPolicy = policies[0];
                updatePolicy(1, enactedPolicy.toLowerCase());
                gameState.failedElections = 0; 
                gameState.currentPolicies = [];
                gameState.sessionPhase = null;
                gameState.view = 'game_board';
            }
            render();
        };
        
        const incrementFailedElections = () => {
            if (gameState.policies.liberal >= 5 || gameState.policies.fascist >= 6) {
                console.error("Game is over. Cannot increment failed elections.");
                return;
            }
            
            gameState.failedElections = Math.min(3, gameState.failedElections + 1);
            
            if (gameState.failedElections === 3) {
                handleChaosPolicy();
            }
            render();
        };
        
        const resetFailedElections = () => {
            gameState.failedElections = 0;
            render();
        };
        
        const handleChaosPolicy = () => {
            const chaosPolicy = drawPolicy();
            
            if (chaosPolicy) {
                updatePolicy(1, chaosPolicy.toLowerCase());
                gameState.failedElections = 0;
                showTemporaryMessage(`CHAOS POLICY ENACTED: ${chaosPolicy}! Failed Elections Reset.`);
            } else {
                 console.error("Could not draw chaos policy. Deck empty.");
            }
        };
        
        const showTemporaryMessage = (message) => {
            const board = document.getElementById('app-container');
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 p-3 bg-yellow-500 text-gray-900 font-bold rounded-lg shadow-xl z-50 transition-opacity duration-300';
            toast.textContent = message;
            board.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        };

        const startPolicyPeek = () => {
            if (!gameState.policyPeekAvailable) return;

            // Peek the top 3 cards from the deck (last 3 elements of array)
            const policies = gameState.deck.slice(-3).reverse(); 
            
            if (policies.length === 0) {
                 console.error("Deck is empty. Cannot peek.");
                 return;
            }
            
            gameState.policyPeekAvailable = false;
            gameState.peekedPolicies = policies;
            gameState.nextPhaseData = { type: 'policy_peek', role: 'President' }; 
            gameState.view = 'privacy_screen';
            render();
        };

        const handleResetGame = () => {
            // Store the wake lock preference before reset
            const wasWakeLockActive = gameState.isWakeLockActive;

            // Reset to the default state
            Object.assign(gameState, DEFAULT_GAME_STATE);
            
            // Restore the wake lock setting on reset
            gameState.isWakeLockActive = wasWakeLockActive;
            
            // Clear all data *except* the wake lock setting from local storage
            clearSavedGameState(); 
            
            // If the wake lock was active, release it to ensure a fresh state for re-requesting later
            if (wasWakeLockActive) {
                releaseWakeLock(); // This also calls render()
            } else {
                render(); // Otherwise, just render
            }
        };

        // --- UI Rendering Functions ---
        
        const renderPrivacyScreen = () => {
            const data = gameState.nextPhaseData;
            if (!data) return document.createElement('div');

            const isRoleReveal = data.type === 'role_reveal';
            
            // Get the player ID for role reveal
            const roleText = isRoleReveal ? `Player ${data.playerId}` : data.role;
            
            // Determine the next view based on the current context
            let nextView;
            if (data.type === 'role_reveal') {
                nextView = 'role_reveal';
            } else if (data.type === 'legislation') {
                nextView = 'legislation_session';
            } else if (data.type === 'policy_peek') {
                nextView = 'policy_peek_display';
            } else {
                nextView = 'game_board';
            }

            const privacyDiv = document.createElement('div');
            privacyDiv.className = 'flex flex-col items-center justify-center min-h-screen p-6 text-center bg-gray-900 text-white';
            
            privacyDiv.innerHTML = `
                <div class="w-full max-w-sm bg-gray-800 p-8 shadow-2xl rounded-xl border-4 border-yellow-500 animate-pulse">
                    <h1 class="text-4xl font-extrabold text-yellow-400 mb-4 uppercase">
                        PRIVATE ACCESS
                    </h1>
                    <p class="text-lg font-medium text-gray-300 mb-8">
                        Pass the device to <strong>${roleText}</strong>.
                    </p>
                    
                    <button id="proceed-btn" class="mt-4 w-full py-4 px-4 bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold rounded-xl shadow-lg transition duration-150 ease-in-out transform hover:scale-[1.05] text-xl">
                        I AM ${roleText} - TAP TO PROCEED
                    </button>
                </div>
                <!-- Only allow returning to the board if not in the middle of initial role reveal -->
                ${data.type !== 'role_reveal' ? `
                <button id="cancel-btn" class="mt-8 text-xs text-gray-400 hover:text-red-400 transition-colors">
                    Cancel and Return to Board
                </button>
                ` : ''}
            `;

            privacyDiv.querySelector('#proceed-btn').addEventListener('click', () => {
                gameState.view = nextView;
                gameState.nextPhaseData = null; // Clear context
                render();
            });

            if (data.type !== 'role_reveal') {
                privacyDiv.querySelector('#cancel-btn').addEventListener('click', () => {
                    gameState.view = 'game_board';
                    gameState.nextPhaseData = null;
                    
                    // Reset current session state if cancelling mid-legislation
                    if (data.type === 'legislation') {
                        gameState.deck = gameState.deck.concat(gameState.currentPolicies);
                        shuffle(gameState.deck);
                        gameState.currentPolicies = [];
                        gameState.sessionPhase = null;
                    }
                    if (data.type === 'policy_peek') {
                        gameState.policyPeekAvailable = true; 
                        gameState.peekedPolicies = [];
                    }

                    render();
                });
            }

            return privacyDiv;
        };


        // Function to generate the HTML for the role distribution summary
        const getDistributionSummary = (count) => {
            const dist = ROLE_DISTRIBUTION[count];
            if (!dist) return '';

            const knowledgeRule = dist.knowledge;

            return `
                <div class="mt-4 p-3 bg-gray-100 rounded-lg shadow-inner text-sm border-l-4 border-red-500">
                    <p class="font-bold text-gray-700 mb-1">Role Distribution for ${count} Players:</p>
                    <ul class="list-none p-0 ml-4 mb-2 grid grid-cols-3 gap-y-1">
                        <li class="col-span-1 text-green-700 font-semibold">${dist.L} Liberal(s)</li>
                        <li class="col-span-1 text-red-700 font-semibold">${dist.F} Fascist(s)</li>
                        <li class="col-span-1 text-red-900 font-bold">1 Hitler</li>
                    </ul>
                    <p class="text-xs text-gray-600 mt-2 font-medium">
                        <span class="font-bold">Knowledge Rule:</span> ${knowledgeRule}
                    </p>
                </div>
            `;
        };

        const renderSetup = () => {
            const setupDiv = document.createElement('div');
            setupDiv.className = 'p-6 flex flex-col items-center justify-center min-h-screen bg-gray-50';
            setupDiv.innerHTML = `
                <div class="w-full max-w-sm bg-white p-6 shadow-2xl rounded-xl">
                    <h1 class="text-3xl font-extrabold text-center text-gray-800 mb-6 font-inter">Secret Hitler Pass and Play</h1>
                    <p class="text-center text-gray-600 mb-8">Select the number of players to start the role assignment phase.</p>
                    
                    <label for="player-select" class="block text-sm font-medium text-gray-700 mb-2">Number of Players (5-10)</label>
                    <select id="player-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-red-500 focus:border-red-500 text-lg">
                        ${[5, 6, 7, 8, 9, 10].map(n => 
                            `<option value="${n}" ${n === gameState.playerCount ? 'selected' : ''}>${n} Players</option>`
                        ).join('')}
                    </select>
                    
                    <!-- Role Distribution Summary Area -->
                    <div id="distribution-summary">
                        ${getDistributionSummary(gameState.playerCount)}
                    </div>

                    <button id="start-game-btn" class="mt-8 w-full py-3 px-4 bg-red-600 hover:bg-red-700 text-white font-bold rounded-xl shadow-lg transition duration-150 ease-in-out transform hover:scale-[1.02]">
                        Start Role Assignment
                    </button>
                    
                    <!-- Attribution and License Footer -->
                    <div class="mt-6 w-full text-center text-xs text-gray-500 p-2 border-t border-gray-200">
                        <p>
                            All credits go to the original game's creator, available at
                            <a href="https://www.secrethitler.com/" target="_blank" class="text-red-600 hover:text-red-700 underline font-medium">SecretHitler.com</a>.
                        </p>
                        <p class="mt-1">
                            This digital adaptation is licensed under
                            <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" class="text-red-600 hover:text-red-700 underline font-medium">Creative Commons BY–NC–SA 4.0 International License</a>,
                            in compliance with the original game's license.
                        </p>
                    </div>

                </div>
            `;

            setupDiv.querySelector('#player-select').addEventListener('change', (e) => {
                gameState.playerCount = parseInt(e.target.value);
                // Update the summary dynamically
                document.getElementById('distribution-summary').innerHTML = getDistributionSummary(gameState.playerCount);
            });

            setupDiv.querySelector('#start-game-btn').addEventListener('click', () => {
                assignRoles(gameState.playerCount);
                initDeck(); // Initialize the policy deck when the game starts
                gameState.revealIndex = 0;
                
                // Start with a privacy screen for the first player
                gameState.nextPhaseData = { type: 'role_reveal', playerId: gameState.players[0].id };
                gameState.view = 'privacy_screen'; 
                render();
            });

            return setupDiv;
        };

        const renderRoleReveal = () => {
            const player = gameState.players[gameState.revealIndex];
            const playerCount = gameState.playerCount;
            
            // Generate teammate info using Player IDs
            let teammatesInfo = '';
            
            // Default knowledge for Liberal and 7+ Hitler: You know nothing.
            if (player.role === 'Liberal' || (player.role === 'Hitler' && playerCount >= 7)) {
                 teammatesInfo = `<p class="text-lg mt-8 font-semibold text-green-700">You do not know any other player's role.</p>`;
            } else if (player.party === 'Fascist') {
                // All Fascist Party members (Fascists and Hitler) who DO know roles
                const knownIds = player.knownTeammates;
                const hitlerId = gameState.players.find(p => p.role === 'Hitler')?.id;

                
                // 5-6 Players: Fascists and Hitler know all other Fascist party members
                if (playerCount <= 6) {
                    const otherFascistIds = knownIds.filter(id => id !== hitlerId);
                    
                    teammatesInfo = `
                        <p class="text-xl mt-4 font-semibold text-gray-800">Your Teammates (Fascists):</p>
                        <p class="text-lg">${otherFascistIds.map(id => `Player ${id}`).join(', ') || 'None'}</p>
                        <p class="text-xl mt-4 font-semibold text-gray-800">Hitler is:</p>
                        <p class="text-3xl font-extrabold text-red-700">Player ${hitlerId || 'Error'}</p>
                    `;
                } 
                
                // 7+ Players: Fascists know Fascists and Hitler.
                else if (playerCount >= 7 && player.role === 'Fascist') {
                    const otherFascistIds = knownIds.filter(id => id !== hitlerId);
                    
                    teammatesInfo = `
                        <p class="text-xl mt-4 font-semibold text-gray-800">Other Fascists:</p>
                        <p class="text-lg">${otherFascistIds.map(id => `Player ${id}`).join(', ') || 'None'}</p>
                        <p class="text-xl mt-4 font-semibold text-gray-800">Hitler is:</p>
                        <p class="text-3xl font-extrabold text-red-700">Player ${hitlerId || 'Error'}</p>
                    `;
                }
            }


            const roleRevealDiv = document.createElement('div');
            roleRevealDiv.className = 'flex flex-col items-center justify-center min-h-screen p-4 text-center';
            roleRevealDiv.style.backgroundColor = player.party === 'Liberal' ? '#ebfbee' : '#feebeb'; // Light green/red background
            
            roleRevealDiv.innerHTML = `
                <div class="p-6 rounded-2xl shadow-2xl w-full max-w-sm bg-white transform transition-all duration-300 ease-out">
                    <p class="text-2xl font-bold text-gray-600 mb-4">
                        <span class="text-red-600">Player ${player.id}</span>'s Turn
                    </p>
                    
                    <div id="role-display" class="border-4 p-8 rounded-xl transition-opacity duration-500 ease-in-out" style="border-color: ${player.party === 'Liberal' ? '#10b981' : '#ef4444'};">
                        <p class="text-2xl text-gray-500 font-medium">Your Role Is:</p>
                        <h2 class="text-5xl font-black mt-2 mb-4 uppercase" style="color: ${player.role === 'Liberal' ? '#10b981' : player.role === 'Fascist' ? '#ef4444' : '#991b1b'};">
                            ${player.role}
                        </h2>
                        <p class="text-lg font-medium text-gray-700">${player.party} Party</p>
                        ${teammatesInfo}
                    </div>

                    <button id="next-player-btn" class="mt-10 w-full py-4 px-4 bg-gray-800 hover:bg-gray-900 text-white font-extrabold rounded-xl shadow-lg transition duration-150 ease-in-out transform hover:scale-105 text-xl">
                        CONFIRM & PASS PHONE
                    </button>
                    
                    <p class="text-xs text-gray-400 mt-4">(${playerCount - 1 - gameState.revealIndex} players left)</p>
                </div>
            `;

            roleRevealDiv.querySelector('#next-player-btn').addEventListener('click', () => {
                gameState.revealIndex++; 
                
                if (gameState.revealIndex >= gameState.playerCount) {
                    gameState.view = 'game_board';
                    gameState.revealIndex = 0; 
                    gameState.policies.liberal = 0; 
                    gameState.policies.fascist = 0;
                    gameState.failedElections = 0; 
                } else {
                    // Transition to privacy screen for the next player using their internal ID
                    gameState.nextPhaseData = { 
                        type: 'role_reveal', 
                        playerId: gameState.players[gameState.revealIndex].id 
                    };
                    gameState.view = 'privacy_screen';
                }
                render();
            });

            return roleRevealDiv;
        };
        
        const renderLegislationSession = () => {
            const policies = gameState.currentPolicies;
            const isPresident = gameState.sessionPhase === 'PRESIDENT_DISCARD';
            const role = isPresident ? 'President' : 'Chancellor';
            const action = isPresident ? 'DISCARD ONE' : 'DISCARD ONE (Enact the remaining)';

            const sessionDiv = document.createElement('div');
            sessionDiv.className = 'flex flex-col items-center justify-center min-h-screen p-4 text-center bg-gray-900 text-white';
            
            sessionDiv.innerHTML = `
                <div class="w-full max-w-sm bg-gray-800 p-6 shadow-2xl rounded-xl">
                    <p class="text-3xl font-extrabold mb-2 text-yellow-300">
                        LEGISLATION SESSION
                    </p>
                    <h2 class="text-xl font-semibold text-gray-300 mb-6">
                        ${role}'s Turn: <span class="text-yellow-400 font-bold">${action}</span>
                    </h2>
                    <p class="text-sm text-gray-400 mb-6">
                        Click the policy card you wish to discard.
                    </p>

                    <div id="policy-cards" class="flex justify-center space-x-2 md:space-x-4 mb-8">
                        ${policies.map((policy, index) => `
                            <div class="policy-card flex-1 p-3 md:p-4 rounded-xl shadow-lg cursor-pointer transform transition duration-200 ease-in-out hover:scale-105 active:scale-95 text-center font-black uppercase text-2xl md:text-3xl" 
                                data-index="${index}"
                                style="background-color: ${policy === 'Liberal' ? '#10b981' : '#ef4444'}; color: white; border: 3px solid ${policy === 'Liberal' ? '#059669' : '#b91c1c'}; height: 120px; display: flex; align-items: center; justify-content: center; user-select: none;">
                                ${policy.charAt(0)}
                            </div>
                        `).join('')}
                    </div>
                    
                    ${policies.length === 1 ? '<p class="text-lg font-bold text-green-400">Policy ready to be Enacted.</p>' : ''}


                    <p class="text-xs text-gray-400 mt-4">
                        Policies Remaining in Deck: ${gameState.deck.length} | Discard Pile: ${gameState.discard.length}
                    </p>
                </div>

                <button id="cancel-session-btn" class="mt-8 w-full max-w-sm py-3 bg-red-800 hover:bg-red-900 text-white font-bold rounded-xl transition duration-150 text-sm">
                    Cancel Session (Failed Election)
                </button>
            `;

            sessionDiv.querySelectorAll('.policy-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.getAttribute('data-index'));
                    handleDiscard(index);
                });
            });
            
            sessionDiv.querySelector('#cancel-session-btn').addEventListener('click', () => {
                gameState.deck = gameState.deck.concat(gameState.currentPolicies);
                shuffle(gameState.deck);
                gameState.currentPolicies = [];
                gameState.sessionPhase = null;
                
                incrementFailedElections(); 
                
                gameState.view = 'game_board';
                render();
            });

            return sessionDiv;
        };

        const renderPolicyPeekDisplay = () => {
            const policies = gameState.peekedPolicies;
            
            const peekDisplayDiv = document.createElement('div');
            peekDisplayDiv.className = 'flex flex-col items-center justify-center min-h-screen p-4 text-center bg-gray-900 text-white';
            
            peekDisplayDiv.innerHTML = `
                <div class="w-full max-w-sm bg-gray-800 p-6 shadow-2xl rounded-xl border-4 border-blue-500">
                    <p class="text-3xl font-extrabold mb-2 text-blue-300">
                        CONFIDENTIAL INFORMATION
                    </p>
                    <h2 class="text-xl font-semibold text-gray-300 mb-6">
                        The next 3 policies in the deck are:
                    </h2>
                    
                    <div id="policy-cards" class="flex justify-center space-x-2 md:space-x-4 mb-8">
                        ${policies.map((policy, index) => `
                            <div class="flex-1 p-3 md:p-4 rounded-xl shadow-lg text-center font-black uppercase text-2xl md:text-3xl" 
                                style="background-color: ${policy === 'Liberal' ? '#10b981' : '#ef4444'}; color: white; border: 3px solid ${policy === 'Liberal' ? '#059669' : '#b91c1c'}; height: 120px; display: flex; align-items: center; justify-content: center; user-select: none;">
                                ${policy.charAt(0)}
                            </div>
                        `).join('')}
                    </div>

                    <button id="acknowledge-btn" class="mt-4 w-full py-4 px-4 bg-blue-500 hover:bg-blue-600 text-gray-900 font-bold rounded-xl shadow-lg transition duration-150 ease-in-out transform hover:scale-[1.05] text-xl">
                        ACKNOWLEDGE & RETURN TO BOARD
                    </button>
                    
                    <p class="text-xs text-gray-400 mt-4">
                        (The deck has NOT been modified)
                    </p>
                </div>
            `;

            peekDisplayDiv.querySelector('#acknowledge-btn').addEventListener('click', () => {
                gameState.peekedPolicies = []; 
                gameState.view = 'game_board';
                render();
            });

            return peekDisplayDiv;
        };
        
        const renderGameBoard = () => {
            const boardDiv = document.createElement('div');
            boardDiv.className = 'flex flex-col items-center p-4 pt-4 min-h-screen bg-gray-900 font-inter text-white';
            boardDiv.innerHTML = `
                <div class="w-full max-w-md game-board-wrapper"> 
                    <h1 class="text-3xl font-extrabold text-center text-gray-100 mb-4">SECRET HITLER PASS AND PLAY</h1>
                    
                    <!-- Policy Counts -->
                    <div class="flex justify-center items-center mb-6 text-base font-semibold border-b border-gray-700 pb-2">
                        <span class="text-gray-300 mr-2">Policies Passed:</span>
                        <span id="liberal-count" class="text-green-400 font-bold">${gameState.policies.liberal} L</span>
                        <span class="text-gray-500 mx-2">/</span>
                        <span id="fascist-count" class="text-red-400 font-bold">${gameState.policies.fascist} F</span>
                        <span class="text-xs ml-4 text-gray-500">Deck: ${gameState.deck.length} | Discard: ${gameState.discard.length}</span>
                    </div>

                    <!-- Failed Elections Tracker (COMPACT LAYOUT) -->
                    <div class="p-3 bg-gray-800 rounded-xl shadow-lg mb-6 border border-yellow-500">
                        
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-extrabold text-yellow-300">Failed Elections</h3>
                            
                            <div id="failed-elections-track" class="flex space-x-2">
                                ${Array.from({ length: 3 }).map((_, i) => `
                                    <div id="E${i+1}" class="w-8 h-8 flex items-center justify-center rounded-full font-bold text-base transition-colors duration-200 ease-in-out
                                        ${i < gameState.failedElections ? 'bg-yellow-500 text-gray-900 shadow-md border-2 border-yellow-300' : 'bg-gray-700 text-gray-500 border-2 border-yellow-600'}">
                                        ${i+1}
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="flex justify-between space-x-4 mt-4">
                            <button id="add-election-btn" class="flex-1 py-2 px-3 bg-yellow-600 hover:bg-yellow-700 text-gray-900 font-bold rounded-lg text-sm transition transform hover:scale-[1.02] active:scale-95">
                                <svg class="w-4 h-4 inline-block -mt-0.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                                Add Fail
                            </button>
                            <button id="reset-elections-btn-large" class="flex-1 py-2 px-3 bg-gray-600 hover:bg-gray-700 text-white font-bold rounded-lg text-sm transition transform hover:scale-[1.02] active:scale-95">
                                Reset
                            </button>
                        </div>
                        <p class="text-center text-xs text-red-400 mt-2 font-medium">${gameState.failedElections === 2 ? '⚠️ Next fail causes Chaos Policy!' : ''}</p>
                    </div>

                    <!-- Liberal Policy Track (TALLER SLOTS) -->
                    <div class="mb-6">
                        <h2 class="text-xl font-bold mb-2 text-green-300 border-b border-green-700 pb-1">Liberal Policies</h2>
                        <div id="liberal-track" class="flex justify-between space-x-2">
                            ${Array.from({ length: 5 }).map((_, i) => `
                                <div id="L${i+1}" class="policy-slot liberal-slot w-1/5 h-24 flex flex-col items-center justify-center rounded-lg font-bold transition-colors duration-200 text-xl p-1
                                    bg-gray-700 border-2 border-green-600 text-green-300">
                                    <span class="text-base">${i+1}</span>
                                    <!-- This span inherits the white color when the slot is active due to the updatePolicyTrack logic -->
                                    <span class="text-[10px] text-center font-medium leading-tight mt-1">Liberal<br>Policy</span>
                                </div>
                            `).join('')}
                        </div>
                        <p id="liberal-win" class="text-center mt-3 text-green-500 font-extrabold text-2xl hidden animate-pulse">LIBERALS WIN!</p>
                    </div>

                    <!-- Fascist Policy Track - EMHAPSIZED -->
                    <div class="mb-6">
                        <h2 class="text-xl font-bold mb-4 text-red-300 border-b border-red-700 pb-1">Fascist Policies</h2>
                        
                        <!-- Thin Bar Indicator Area using Grid -->
                        <div class="grid grid-cols-6 gap-2 w-full h-8 mb-2">
                            <!-- F3: Hitler Election Condition -->
                            <div class="col-span-1 col-start-3 flex flex-col items-center justify-end">
                                <div class="h-1 w-full bg-yellow-500 rounded-full"></div>
                                <span class="text-[10px] font-bold text-yellow-400 mt-1 leading-none text-center">HITLER<br>ELECTION</span>
                            </div>
                            
                            <!-- F5: Veto Enabled -->
                            <div class="col-span-1 col-start-5 flex flex-col items-center justify-end">
                                <div class="h-1 w-full bg-blue-500 rounded-full"></div>
                                <span class="text-[10px] font-bold text-blue-400 mt-1 leading-none text-center">VETO<br>ENABLED</span>
                            </div>
                        </div>

                        <div id="fascist-track" class="grid grid-cols-6 gap-2">
                            ${Array.from({ length: 6 }).map((_, i) => {
                                const policyNumber = i + 1;
                                // Use policyNumber (1-6) to get the description
                                const power = getPowerDescription(policyNumber);
                                const isPower = power && power !== '-'; 

                                return `
                                    <div id="F${policyNumber}" class="policy-slot col-span-1 h-24 flex flex-col items-center justify-center rounded-lg shadow-inner transition-all duration-300 ease-in-out 
                                        bg-gray-700 border-2 border-red-600 text-gray-400 p-1">
                                        <span class="text-base font-bold">${policyNumber}</span>
                                        ${isPower && policyNumber <= 5 ? `<span class="text-[10px] text-center font-medium leading-tight mt-1">${power.split(' ').join('<br>')}</span>` : ''}
                                        ${policyNumber === 6 ? `<span class="text-[10px] text-center font-medium leading-tight mt-1 text-red-400">FASCIST<br>WIN</span>` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <p id="fascist-win" class="text-center mt-3 text-red-500 font-extrabold text-2xl hidden animate-pulse">FASCISTS WIN!</p>
                    </div>

                    <!-- Action Button Group (Policy Peek OR Legislation) -->
                    <div class="mt-8">
                        <!-- Note: The Policy Peek function is currently used to represent all Investigate powers -->
                        ${gameState.policyPeekAvailable ? `
                            <button id="start-peek-btn" class="w-full py-4 px-4 bg-blue-500 hover:bg-blue-600 text-white font-bold rounded-xl shadow-lg transition duration-150 ease-in-out transform hover:scale-[1.02] text-xl mb-4 border-2 border-blue-300">
                                EXECUTIVE ACTION: Peek Next 3 Policies
                            </button>
                        ` : ''}
                        
                        <button id="start-legislation-btn" class="w-full py-4 px-4 bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold rounded-xl shadow-lg transition duration-150 ease-in-out transform hover:scale-[1.02] text-xl mb-4 ${gameState.policyPeekAvailable ? 'opacity-50 pointer-events-none' : ''}">
                            Start Legislation Session (Draw 3)
                        </button>
                    </div>

                    <!-- Footer Button Group (Wake Lock, Rules, Reset) -->
                    <div class="flex justify-center space-x-4 mt-6 pt-4 border-t border-gray-700">
                        <!-- NEW: Wake Lock Button -->
                        <button id="toggle-wake-lock-btn" class="flex-1 py-1 px-4 font-medium text-xs rounded-lg transition duration-150 flex items-center justify-center border 
                            ${gameState.isWakeLockActive ? 'bg-green-600 hover:bg-green-700 text-white border-green-400' : 'bg-gray-600 hover:bg-gray-700 text-gray-400 border-gray-400'}">
                            <!-- SVG Icon (Sun for ON, Clock for OFF) -->
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                    d="${gameState.isWakeLockActive ? 'M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z' : 'M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z'}"></path>
                            </svg>
                            ${gameState.isWakeLockActive ? 'Screen ON' : 'Screen OFF'}
                        </button>
                        
                        <a href="https://www.secrethitler.com/assets/Secret_Hitler_Rules.pdf" target="_blank" class="flex-1 py-1 px-4 text-white border border-white hover:bg-white hover:text-gray-900 font-medium text-xs rounded-lg transition duration-150 flex items-center justify-center">
                            Rules
                        </a>
                        <button id="reset-game-btn" class="flex-1 py-1 px-4 bg-indigo-800 hover:bg-indigo-900 text-gray-400 hover:text-white font-medium text-xs rounded-lg transition duration-150">
                            Reset Game Setup
                        </button>
                    </div>
                    
                </div>

                <!-- Reset Confirmation Modal -->
                <div id="reset-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
                    <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-xs text-center border-t-4 border-red-500">
                        <h3 class="text-xl font-bold text-white mb-4">Confirm Reset</h3>
                        <p class="text-gray-300 mb-6">Are you sure you want to discard this game and return to the setup screen?</p>
                        <div class="flex justify-between space-x-4">
                            <button id="confirm-reset-btn" class="flex-1 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition transform hover:scale-105">
                                Yes, Reset
                            </button>
                            <button id="cancel-reset-btn" class="flex-1 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Event Listeners 
            boardDiv.querySelector('#start-legislation-btn').addEventListener('click', startLegislation);
            
            if (gameState.policyPeekAvailable) {
                boardDiv.querySelector('#start-peek-btn').addEventListener('click', startPolicyPeek);
            }

            boardDiv.querySelector('#add-election-btn').addEventListener('click', incrementFailedElections);
            boardDiv.querySelector('#reset-elections-btn-large').addEventListener('click', resetFailedElections);
            
            // NEW: Wake Lock Button Listener
            boardDiv.querySelector('#toggle-wake-lock-btn').addEventListener('click', () => {
                if (gameState.isWakeLockActive) {
                    releaseWakeLock();
                } else {
                    requestWakeLock();
                }
            });


            // 1. Show modal when reset button is clicked
            boardDiv.querySelector('#reset-game-btn').addEventListener('click', () => {
                const modal = document.getElementById('reset-modal');
                if (modal) {
                    modal.classList.remove('hidden');
                }
            });
            
            // 2. Attach listeners for the modal buttons
            setTimeout(() => { 
                const modal = document.getElementById('reset-modal');
                if (modal) {
                    document.getElementById('confirm-reset-btn').addEventListener('click', () => {
                        modal.classList.add('hidden');
                        handleResetGame(); 
                    });

                    document.getElementById('cancel-reset-btn').addEventListener('click', () => {
                        modal.classList.add('hidden'); 
                    });
                }
            }, 0); 

            return boardDiv;
        };

        const updatePolicy = (delta, type) => {
            if (type === 'liberal') {
                const newCount = Math.min(5, Math.max(0, gameState.policies.liberal + delta));
                if (newCount !== gameState.policies.liberal) {
                    gameState.policies.liberal = newCount;
                }
            } else if (type === 'fascist') {
                const newCount = Math.min(6, Math.max(0, gameState.policies.fascist + delta));
                
                if (newCount !== gameState.policies.fascist && delta > 0) {
                    // Only process power change if a new policy was enacted (delta > 0)
                    gameState.policies.fascist = newCount;

                    const count = newCount;
                    const playerCount = gameState.playerCount;
                    const powersArray = ROLE_DISTRIBUTION[playerCount]?.powers;
                    // F1 is index 0, F6 is index 5
                    const enactedPowerName = powersArray[count - 1]; 
                    
                    if (enactedPowerName === 'Peak next policies') {
                        // Use existing flag to enable the 'peek' functionality
                        gameState.policyPeekAvailable = true;
                        showTemporaryMessage(`PEAK POLICIES POWER ACTIVATED!`);
                    } 
                    // If any other power is enacted (Execution or Special Election), it is tracked but also clears any pending investigation/peek.
                    else if (enactedPowerName !== '-' && count < 6) {
                        if (gameState.policyPeekAvailable) {
                            gameState.policyPeekAvailable = false;
                            console.log("Pending Investigate power cleared by new enactment.");
                        }
                        showTemporaryMessage(`EXECUTIVE POWER ENACTED: ${enactedPowerName.toUpperCase()}!`);
                    }
                } else if (newCount !== gameState.policies.fascist) {
                    gameState.policies.fascist = newCount;
                }
            }
            updatePolicyTrack();
        };

        const updatePolicyTrack = () => {
            if (gameState.view !== 'game_board') return;

            const libCountEl = document.getElementById('liberal-count');
            const fascCountEl = document.getElementById('fascist-count');
            const libWinEl = document.getElementById('liberal-win');
            const fascWinEl = document.getElementById('fascist-win');
            
            if (!libCountEl || !fascCountEl) return;

            libCountEl.textContent = `${gameState.policies.liberal} L`;
            fascCountEl.textContent = `${gameState.policies.fascist} F`;
            
            // --- Election Track Update (Visual) ---
            for (let i = 1; i <= 3; i++) {
                const slot = document.getElementById(`E${i}`);
                if (slot) {
                    if (i <= gameState.failedElections) {
                        slot.classList.remove('bg-gray-700', 'text-gray-500', 'border-2', 'border-yellow-600');
                        slot.classList.add('bg-yellow-500', 'text-gray-900', 'shadow-md', 'border-2', 'border-yellow-300');
                    } else {
                        slot.classList.remove('bg-yellow-500', 'text-gray-900', 'shadow-md', 'border-2', 'border-yellow-300');
                        slot.classList.add('bg-gray-700', 'text-gray-500', 'border-2', 'border-yellow-600');
                    }
                }
            }


            // --- Liberal Track Update (NOW USES TEXT-WHITE WHEN ACTIVE) ---
            for (let i = 1; i < 6; i++) {
                const slot = document.getElementById(`L${i}`);
                if (slot) {
                    if (i <= gameState.policies.liberal) {
                        // When active: Remove inactive colors, Add active colors (text-white)
                        slot.classList.remove('bg-gray-700', 'text-green-300');
                        slot.classList.add('bg-green-500', 'text-white', 'shadow-2xl', 'scale-105');
                    } else {
                        // When inactive: Add inactive colors (text-green-300), Remove active colors (text-white)
                        slot.classList.add('bg-gray-700', 'text-green-300');
                        slot.classList.remove('bg-green-500', 'text-white', 'shadow-2xl', 'scale-105');
                    }
                }
            }

            // --- Fascist Track Update ---
            for (let i = 1; i < 7; i++) {
                const slot = document.getElementById(`F${i}`);
                if (slot) {
                    slot.classList.remove('bg-red-500', 'text-white', 'shadow-2xl', 'scale-105', 'text-red-700/50'); 
                    slot.classList.add('bg-gray-700', 'text-gray-400', 'border-2', 'border-red-600');
                    
                    if (i <= gameState.policies.fascist) {
                        slot.classList.remove('bg-gray-700', 'text-gray-400');
                        slot.classList.add('bg-red-500', 'text-white', 'shadow-2xl', 'scale-105');
                    } 
                }
            }

            // --- Win Conditions ---
            if (gameState.policies.liberal >= 5) {
                libWinEl.classList.remove('hidden');
                fascWinEl.classList.add('hidden');
            } else if (gameState.policies.fascist >= 6) {
                fascWinEl.classList.remove('hidden');
                libWinEl.classList.add('hidden');
            } else {
                libWinEl.classList.add('hidden');
                fascWinEl.classList.add('hidden');
            }
        };


        // Initial setup check for wake lock
        if (gameState.isWakeLockActive) {
            // Attempt to re-request the lock if the user had it active
            requestWakeLock();
        }

        // Initial render on load (this will call loadGameState indirectly via render)
        window.onload = render;
    </script>
    <style>
        /* Custom styles for aesthetic */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Mobile first sizing: enforce full screen for all views */
        #app-container {
            min-height: 100vh;
            width: 100vw;
            transition: transform 0.3s ease-in-out; 
        }

        /* Landscape Orientation Rules: Adjust board width but do NOT rotate. */
        @media (orientation: landscape) {
            #app-container {
                width: 100vw;
                height: 100vh;
                overflow: hidden; 
            }
            
            /* Increase the functional width of the board wrapper for wide screens */
            .game-board-wrapper {
                width: 95vw; 
                max-width: 800px; 
            }
        }

        .policy-slot {
            transition: all 0.3s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        /* Custom class for the policy cards in the session view */
        .policy-card {
            border: 3px solid transparent;
            min-width: 80px;
        }
        /* For the privacy screen prompt */
        .animate-pulse {
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
    </style>
</head>
<body class="antialiased">
    <div id="app-container">
        <!-- Content will be rendered here by JavaScript -->
    </div>
</body>
</html>

